@(form: Form[WidgetForm.Data], postUrl: Call, checkbeds: Seq[WidgetForm.CheckBeds], configuration: play.api.Configuration, fieldsById: List[Map[String, String]])(implicit request: RequestHeader, messages: Messages)

@import views.minimal._
@import com.github.nscala_time.time.Imports._
@import org.joda.time.format.ISODateTimeFormat

@fc_price = @{ helper.FieldConstructor(minimal.priceFieldConstructor.f) }

@main("Keeyosk") {
  @* Flash shows updates to a page *@
  @request.flash.data.map{ case (foo, bar) =>
    <div class=@foo>@bar</div>
  }

  @* Global errors are not tied to any particular form field *@
  @if(form.hasGlobalErrors) {
    @form.globalErrors.map { error: FormError =>
      <div>
        @error.key: @error.message
      </div>
    }
  }

  <script src="@routes.Assets.at("javascripts/jquery.tablesort.min.js")"></script>
  <script type="text/javascript" src="@routes.WidgetController.javascriptRoutes"></script>
  <script type="text/javascript">
    function numberWithCommas(x) {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function reformat(obj) {
      obj.value = `\$${ numberWithCommas(Math.floor(obj.value.replace(/[^\d\.]/g, '')))}`
    }
  </script>

  @helper.form(postUrl) {
    @helper.CSRF.formField
    Rent
    @minimal.inputCheckboxGroup(form("checkbeds"), options = checkbeds.map(g => g.value.toString -> g.name))(handler = fc_price, implicitly[Messages])
    in 
    @minimal.inputDropdown(field = form("autocomplete"))(handler = fc_price, implicitly[Messages])
    between
    @minimal.inputText(field = form("rentlo"), args = 'size -> 10)(handler = fc_price, implicitly[Messages])
    and     
    @minimal.inputText(field = form("renthi"), args = 'size -> 10)(handler = fc_price, implicitly[Messages])

    <script>
    $('.ui.dropdown').dropdown({
      apiSettings: {
        url: '/autocomplete?query={query}'
      },
      keepOnScreen: false,
    });

    function NonemptyAutocomplete() {
      if (!$('#autocomplete').val()) {
        $('#autocomplete').val("Manhattan");
      }
      if (!$("input[name='checkbeds[]']:checked").length) {
        $('#checkbeds_0').prop("checked", true);
      }
    }
    </script>

    <button onclick="NonemptyAutocomplete()" class="ui primary button">Update</button>
    <hr/>

    @if(!fieldsById.isEmpty) {
      <table class="ui sortable striped table">
        <thead>
          <tr>
            <th class="no-sort">Title</th>
            <th>Price</th>
            <th sorted descending>Posted</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody>
        @for( item <- fieldsById ) {
          <tr>
          <td><a href=@item("link")>@item("title")</td>
          <td data-sort-value=@{"%010.0f".format(item.get("price").fold(0.0)(_.toFloat))}><a href=@item("link")>@item.get("price").fold("unspecified")(x => java.text.NumberFormat.getIntegerInstance.format(x.toFloat.toInt))</td>
          <td data-sort-value=@item("posted")><a href=@item("link")>@ISODateTimeFormat.dateTimeParser().parseDateTime(item("posted")).toString(DateTimeFormat.forPattern("EEE, d MMM h:mm a"))</td>
          <td><a href=@item("link")>@{"%.1f".format(item.get("score").getOrElse("0.0").toFloat)}</td>
          </tr>
        }
        </tbody>
      </table>
      <script>
        $('table').tablesort()
      </script>    
    }
  }
}
